---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import BlogPostCard from '../../../components/BlogPostCard.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('books');
  const publishedPosts = allPosts.filter(post => !post.data.draft);
  
  // Get all unique tags
  const uniqueTags = [...new Set(publishedPosts.flatMap(post => post.data.tags || []))];
  
  return uniqueTags.map(tag => {
    const filteredPosts = publishedPosts
      .filter(post => post.data.tags?.includes(tag))
      .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
    
    return {
      params: { tag },
      props: { posts: filteredPosts, tag }
    };
  });
}

const { posts, tag } = Astro.props;
---

<BaseLayout 
  title={`Books tagged with "${tag}"`}
  description={`All books tagged with ${tag}`}
>
  <Header slot="header" />
  
  <div class="space-y-8">
    <div class="mb-8">
      <a 
        href="/books"
        class="back-link"
      >
        ‚Üê Back to Books
      </a>
    </div>

    <section>
      <h1 class="text-4xl font-bold text-white mb-6">
        Books tagged with "{tag}"
      </h1>

      {posts.length > 0 ? (
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          {posts.map(post => (
            <BlogPostCard
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              slug={post.slug}
              tags={post.data.tags}
              collection="books"
            />
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <p class="empty-message">No books found with this tag.</p>
        </div>
      )}
    </section>
  </div>

  <Footer slot="footer" />
</BaseLayout>

<style>
  .back-link {
    color: var(--color-interactive-primary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    text-decoration: none;
    transition: var(--transition-colors);
    transition-delay: var(--transition-delay-none);
  }

  .back-link:hover {
    color: var(--color-interactive-hover);
    text-decoration: none;
  }

  .back-link:focus-visible {
    outline: 2px solid var(--color-interactive-primary);
    outline-offset: 2px;
    border-radius: var(--radius-sm);
    transition-delay: var(--transition-delay-none);
  }

  .empty-state {
    text-align: center;
    padding: var(--spacing-12) 0;
    background-color: var(--color-bg-content);
    border-radius: var(--radius-lg);
  }

  .empty-message {
    color: var(--color-text-on-light);
    font-size: var(--font-size-lg);
  }
</style>
