---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import QuoteBanner from '../../components/QuoteBanner.astro';
import ContentListItem from '../../components/ContentListItem.astro';

const allBooks = await getCollection('books', ({ data }) => {
  return data.draft === false;
});

const sortedBooks = allBooks.sort((a, b) => {
  return a.data.title.localeCompare(b.data.title);
});
---

<BaseLayout 
  title="Books - My Personal Website"
  description="Explore my book reviews and reading recommendations."
>
  <Header slot="header" />
  
  <div class="main-container">
    <section class="section">
      <QuoteBanner />
      
      <hr style="border: none; border-top: 0.5px solid rgba(255, 255, 255, 0.2); margin-bottom: 3rem;" />
      
      <p class="page-intro">
        I enjoy reading a lot. I try to maintain a record of books I've read <a href="https://docs.google.com/spreadsheets/d/1KBcC6kPlFMojaJ0qsyxlT6AmEO_JHay75Rf9d5mzLcY/edit?usp=sharing" target="_blank" rel="noopener noreferrer">here</a> or on my <a href="https://www.goodreads.com/user/show/94888357-harsh" target="_blank" rel="noopener noreferrer">Goodreads</a> account (feel free to add me). I've created this page to share my thoughts on those books.
      </p>

      <p class="page-intro"> 
        The quotes above are all hand-compiled from my own years of reading. I've tried to make the sources as accurate as possible but if you spot any errors, let me know. The cool thing is that you can refresh the page and it'll show a new quote.
      </p>
    </section>

    <div class="mb-8">
      <div class="flex justify-between items-center mb-8">
        <p class="books-count">
          {sortedBooks.length} {sortedBooks.length === 1 ? 'review' : 'reviews'}
        </p>
        
        <!-- Sort Controls -->
        <div class="flex gap-2 flex-wrap items-center">
        <span class="sort-label">Sort by:</span>
        <button 
          id="sort-title" 
          class="sort-btn sort-btn-active"
        >
          Title
        </button>
        <span class="sort-separator">|</span>
        <button 
          id="sort-author" 
          class="sort-btn"
        >
          Author
        </button>
        <span class="sort-separator">|</span>
        <button 
          id="sort-year" 
          class="sort-btn"
        >
          Year
        </button>
        </div>
      </div>
    </div>

    <ul id="books-list" class="space-y-4" style="margin-top: 3rem; margin-bottom: 8rem;">
      {sortedBooks.map(book => (
        <ContentListItem
          title={book.data.title}
          slug={book.slug}
          collection="books"
          metadata={`by ${book.data.author} (${book.data.publicationYear})`}
          sortData={{
            title: book.data.title,
            author: book.data.author,
            year: book.data.publicationYear
          }}
        />
      ))}
    </ul>

    {sortedBooks.length === 0 && (
      <div class="text-center py-12">
        <p class="empty-message">No books yet. Check back soon!</p>
      </div>
    )}
  </div>

  <Footer slot="footer" />
</BaseLayout>

<style>

  .books-count {
    color: var(--color-text-on-dark);
    font-size: var(--font-size-lg);
  }

  .sort-label {
    color: var(--color-text-on-dark);
  }

  .sort-btn {
    color: var(--color-text-on-dark);
    border-bottom: 2px solid transparent;
    padding-bottom: 4px;
    background: transparent;
    cursor: pointer;
    transition: var(--transition-colors);
    transition-delay: var(--transition-delay-none);
  }

  .sort-btn:hover {
    color: var(--color-interactive);
    background: transparent;
  }

  .sort-btn-active {
    border-bottom-color: var(--color-text-on-dark);
    font-weight: var(--font-weight-medium);
  }

  .sort-separator {
    color: var(--color-text-muted);
  }

  .empty-message {
    color: var(--color-text-muted);
    font-size: var(--font-size-lg);
  }

</style>

<script is:inline>
  function sortBooks(sortBy) {
    const list = document.getElementById('books-list');
    if (!list) {
      console.error('books-list not found');
      return;
    }

    const items = Array.from(list.querySelectorAll('.content-item'));
    
    items.sort((a, b) => {
      const aValue = a.getAttribute('data-' + sortBy) || '';
      const bValue = b.getAttribute('data-' + sortBy) || '';
      
      if (sortBy === 'year') {
        return parseInt(aValue) - parseInt(bValue);
      }
      return aValue.localeCompare(bValue);
    });

    items.forEach(item => list.appendChild(item));

    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.classList.remove('sort-btn-active');
    });
    const activeBtn = document.getElementById('sort-' + sortBy);
    if (activeBtn) {
      activeBtn.classList.add('sort-btn-active');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSorting);
  } else {
    initSorting();
  }

  function initSorting() {
    const titleBtn = document.getElementById('sort-title');
    const authorBtn = document.getElementById('sort-author');
    const yearBtn = document.getElementById('sort-year');

    if (titleBtn) titleBtn.addEventListener('click', () => sortBooks('title'));
    if (authorBtn) authorBtn.addEventListener('click', () => sortBooks('author'));
    if (yearBtn) yearBtn.addEventListener('click', () => sortBooks('year'));
  }
</script>
